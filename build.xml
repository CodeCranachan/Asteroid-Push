<project name="OmegaZone" default="dist" basedir="." xmlns:jacoco="antlib:org.jacoco.ant">
    <description>
        Build file for Omega Zone
    </description>

  <!-- Determine the operating system we are compiling on -->
  <condition property="os.family" value="unix">
    <os family="unix"/>
  </condition>
  <condition property="os.family" value="win32">
    <os family="windows"/>
  </condition>
  <condition property="os.family" value="mac">
    <os family="mac"/>
  </condition>

  <property name="path.classes" location="build/classes"/>
  <property name="path.debug-classes" location="build/debug-classes"/>
  <property name="path.coverage-classes" location="build/instrumented-classes"/>


  <!-- Library files -->
  <path id="libraries.runtime">
    <fileset dir="lib/runtime">
      <include name="lwjgl.jar"/>
      <include name="slick.jar"/>
      <include name="jbox2d-library-2.1.2.2.jar"/>
    </fileset>
  </path>
  <path id="libraries.test">
    <fileset dir="lib/testing">
        <include name="junit-4.10.jar"/>
        <include name="jmock-2.5.1.jar"/>
        <include name="hamcrest-core-1.1.jar"/>
        <include name="hamcrest-library-1.1.jar"/>
        <include name="jmock-legacy-2.5.1.jar"/>
        <include name="cglib-nodep-2.1_3.jar"/>
        <include name="objenesis-1.0.jar"/>
    </fileset>
  </path>

  <!-- Custom tasks -->
  <taskdef uri="antlib:org.jacoco.ant" resource="org/jacoco/ant/antlib.xml">
      <classpath path="lib/testing/jacocoant.jar"/>
  </taskdef>
  <taskdef name="lint4j" classname="com.jutils.lint4j.ant.Lint4jAntTask">
    <classpath>
      <pathelement location="lib/testing/lint4j.jar"/>
    </classpath>
  </taskdef>

  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${path.classes}"/>
    <mkdir dir="${path.debug-classes}"/>
  </target>

  <target name="compile" depends="init" description="compile the source">
    <!-- Compile the java code from src into build -->
    <javac srcdir="src" destdir="${path.classes}" includeantruntime="false" debug="off">
      <classpath>
        <path refid="libraries.runtime"/>
        <path refid="libraries.test"/>
      </classpath>
    </javac>
    <javac srcdir="src" destdir="${path.debug-classes}" includeantruntime="false" debug="on">
      <classpath>
        <path refid="libraries.runtime"/>
        <path refid="libraries.test"/>
      </classpath>
    </javac>
  </target>

  <target name="metrics" depends="compile" description="generating code metrics">
    <lint4j packages="org.skullforge.*" level="5">
      <sourcepath>
        <pathelement location="src"/>
      </sourcepath>
      <classpath>
        <path refid="libraries.runtime"/>
        <path refid="libraries.test"/>
      </classpath>
      <formatters>
        <formatter type="text"/>
        <formatter type="xml" toFile="build/lint4j_report.xml"/>
      </formatters>
    </lint4j>

    <jdepend outputfile="build/jdepend_report.xml" fork="yes" format="xml">
      <classpath>
        <pathelement location="${path.classes}"/>
        <path refid="libraries.test"/>
        <path refid="libraries.runtime"/>
        <pathelement location="lib/testing/jdepend-2.9.1.jar"/>
      </classpath>
      <classespath>
        <pathelement location="build/classes"/>
      </classespath>
    </jdepend>
  </target>

  <target name="test" depends="compile" description="Run test suite">
    <delete file="build/jacoco.exec"/>
    <jacoco:coverage destfile="build/jacoco.exec" append="true">
      <junit fork="true" printsummary="yes" haltonfailure="yes">
        <classpath>
          <pathelement location="${path.debug-classes}"/>
          <path refid="libraries.test"/>
          <path refid="libraries.runtime"/>
        </classpath>

        <batchtest fork="yes" todir="build">
          <fileset dir="src">
             <include name="**/*Test*.java"/>
          </fileset>
          <formatter type="plain"/>
        </batchtest>
      </junit>
    </jacoco:coverage>

    <jacoco:report>
        <executiondata>
            <file file="build/jacoco.exec"/>
        </executiondata>
        <structure name="OmegaZone">
            <classfiles>
                <fileset dir="${path.debug-classes}"/>
            </classfiles>
            <sourcefiles encoding="UTF-8">
                <fileset dir="src"/>
            </sourcefiles>
        </structure>
        <html destdir="build/coverage"/>
    </jacoco:report>
  </target>

  <target name="dist" depends="test,metrics,compile" description="generate the distribution" >
    <!-- Create the manifest file -->
    <mkdir dir="build/"/>
    <manifest file="build/MANIFEST.MF">
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Main-Class" value="org.skullforge.omegazone.OmegaZoneMain"/>
    </manifest>
    
    <!-- Clean out directory to create jar file from -->
    <delete dir="build/jar"/>
    <mkdir dir="build/jar"/>
    <!-- Copy classes -->
    <copy todir="build/jar">
      <fileset dir="${path.classes}" includes="**/*.class" excludes="**/*Test*.class"/>
    </copy>
    <unjar src="lib/runtime/slick.jar" dest="build/jar">
      <patternset>
        <include name="org/**"/>
      </patternset>
    </unjar>
    <unjar src="lib/runtime/lwjgl.jar" dest="build/jar">
      <patternset>
        <include name="org/**"/>
      </patternset>
    </unjar>
    <unjar src="lib/runtime/jbox2d-library-2.1.2.2.jar" dest="build/jar">
      <patternset>
        <include name="org/**"/>
      </patternset>
    </unjar>

    <!-- Create the deployment directory -->
    <mkdir dir="deploy"/>
    <!-- Put everything in $build/jar into the deployment jar file -->
    <jar jarfile="deploy/OmegaZone-${DSTAMP}.jar" basedir="build/jar" manifest="build/MANIFEST.MF"/>
    <!-- Extract native slick files -->
    <unjar src="lib/runtime/natives-${os.family}.jar" dest="deploy"/>
  </target>

  <target name="run" depends="dist" description="run the game">
    <java jar="deploy/OmegaZone-${DSTAMP}.jar" fork="true">
      <jvmarg value="-Djava.library.path=deploy"/>
    </java>
  </target>

  <target name="clean" description="clean up" >
    <!-- Delete the build and dist directory trees -->
    <delete dir="build"/>
    <delete dir="dist"/>
  </target>
</project>